# 2026-02-24

## LevelForge Session - Feature Implementation

### Features Implemented

#### Theme System with Light/Dark Modes
- Added CSS variable-based theming system in Layout.css
- Dark theme (default): #0f0f1a background, dark panels
- Light theme: #f5f5f7 background, white panels
- 5 accent colors: Indigo, Purple, Green, Orange, Red
- System option to follow OS preference
- Theme persistence in localStorage
- Replaced hardcoded colors in Entities.css with CSS variables
- Updated Settings.jsx with functional theme controls
- Active theme button styling with background color
- Active accent color indicator with checkmark

#### #22 Progress Bar for AI Generation
- Added SSE streaming endpoint `/api/generate/stream`
- Progress bar shows step-by-step progress (0% â†’ 100%)
- Status messages: "Initializing" â†’ "Preparing prompt" â†’ "Generating" â†’ "Parsing" â†’ "Validating" â†’ "Complete"
- CSS styling with animated fill

#### #15 Custom Entity Types with Rules
- Database: Added `entity_types` table with metadata_fields column
- Backend: Full CRUD API for entity types per project
- Frontend: Entity management UI with:
  - Emoji picker with 45 game-related emojis
  - Custom emoji input
  - Color picker
  - Placement rules, behavior, collision type
  - Metadata fields (name, type, description, default value)
- Entity types included in AI generation prompts
- Edit/delete functionality for existing entity types

#### Entity Editing in Inspector Panel
- Removed duplicate inspector from Entities.jsx
- Entity edit form now renders in main Layout inspector
- Added "Edit" button in inspector header for selected entities
- Cleaner layout without horizontal squishing
- Moved form state and handlers to App.jsx

#### Level Details in Inspector Panel
- Removed duplicate inspector from Levels.jsx
- Level details now show in main Layout inspector when selected
- Added level icon (ðŸ—º) for selected levels
- Level properties displayed: genre, difficulty, version, theme
- Selected rows highlighted with blue background

#### Library Asset Details in Inspector Panel
- Removed duplicate inspector from Library.jsx
- Assets show details in main Layout inspector when selected
- Category icons displayed based on asset type
- Selected rows highlighted visually

#### Console Panel Tabs (AI Output & Logs)
- Made Console, AI Output, and Logs tabs functional
- Console tab: General app messages (info, warning, error)
- AI Output tab: AI generation progress and results (ai-progress, success)
- Logs tab: System logs and debug messages (system, debug)
- Active tab state with visual indicator
- Log type filtering based on active tab
- Color-coded log types (ai-progress in accent color, system in italic)

#### Level View System (2026-02-24)
- Created LevelView component with three view modes:
  - **Draft View** (functional): ASCII/symbol-based visualization
    - Renders platforms, entities, player spawn, and goals
    - Zoom controls (0.25x to 4x)
    - Grid overlay with pan/zoom support
    - Legend showing entity symbols
    - Level info panel with stats (platforms, entities count)
    - Color-coded entities by type
  - **Polish View** (stub): Custom textures and sprites
  - **Playable View** (stub): Interactive gameplay preview
- Integrated LevelView into Levels tab canvas mode
- Entity symbol mapping (player: ðŸ§‘, enemy: ðŸ‘», coin: ðŸª™, etc.)
- Entity color mapping for visual distinction
- Responsive design with legend/info panels

#### Bug Fixes (2026-02-24)
- **Auto-switch to Canvas view**: Fixed issue where generated levels weren't visible
  - Lifted viewMode state from Levels.jsx to App.jsx for better control
  - Added levelViewMode state in App.jsx
  - Passed viewMode and onViewModeChange props to Levels component
  - Levels component now uses controlled viewMode from props
  - Auto-switch to 'canvas' mode when level is successfully generated
  - Users no longer need to manually click Canvas after generation
  - Newly generated level is immediately visible in Draft View

#### Bug Fixes (2026-02-24)
- **Auto-switch to Canvas view**: Fixed issue where generated levels weren't visible
  - Lifted viewMode state from Levels.jsx to App.jsx for better control
  - Added levelViewMode state in App.jsx
  - Passed viewMode and onViewModeChange props to Levels component
  - Levels component now uses controlled viewMode from props
  - Auto-switch to 'canvas' mode when level is successfully generated
  - Users no longer need to manually click Canvas after generation
  - Newly generated level is immediately visible in Draft View

- **API level_data bug**: Fixed 'No Level Data' error when clicking levels
  - Updated database.py get_levels() to SELECT level_data column
  - Updated main.py API endpoint to include level_data in response
  - Levels now properly display in Canvas Draft view

#### Next Steps for Level View
- Implement drag-and-drop editing in Draft View
- Add asset library integration for Polish View
- Create game engine for Playable View (player movement, collision, win conditions)
- Pan/zoom controls with mouse
- Entity placement and editing tools
- Added extensive logging for level generation process
- Auto-show console panel when errors or AI progress occur
- Better error messages with stack traces
- Request/response logging for debugging
- Event counting to detect empty streams
- Parse error logging for malformed responses
- Console auto-opens on generation start and errors
- **Fixed SSE format**: Events now properly formatted with `data:` prefix and `\n\n` suffix
- **Improved error messages**: Shows response preview when parsing fails
- **Better logging**: Shows response length and first 500 characters
- **Fixed duplicate keys bug**: AI was generating multiple "entities" arrays - parser now merges them
- **Better JSON fixing**: Handles LLM quirks like duplicate sections
- **Fixed level saving bug**: Streaming endpoint now saves levels to database
  - Creates level in database after successful generation
  - Returns saved level with ID and timestamps
  - Generates name from theme, genre, and difficulty
  - Only saves if project_id is provided

#### Known Issues & Solutions
- **Duplicate arrays**: LLM sometimes generates duplicate "entities" or "platforms" arrays - now auto-merged
- **Generation is slow**: Ollama can take several minutes - console shows real-time progress
- **Validation errors**: Negative coordinates trigger automatic retries (up to 3 attempts)

#### Ollama Fallback
- Automatic fallback to local Ollama when OpenAI rate limits hit
- Uses 192.168.68.76:11434 (local network PC)
- No cloud costs for fallback

### UI Improvements
- Entity form layout: Name field on own line for better usability
- Color picker with label on separate row
- Emoji grid with selection highlighting
- Top menu left-aligned with logo separator
- Full viewport layout (no gray areas)
- Inspector panel stays visible at all window widths

### Technical Details
- Installed sse-starlette package for SSE support
- Modified database.py with metadata_fields support
- Updated main.py with streaming endpoint and fallback logic
- CSS variables for theme support across all components
- localStorage for theme preference persistence

### Network
- Frontend: http://192.168.68.72:4173
- Backend: http://192.168.68.72:8000
- Ollama: 192.168.68.76:11434

### Remaining Issues
- Z-AI still not working (API key/account issue)
- Need to test metadata fields in AI generation

---

## Later Session - Enterprise UX Redesign

### Major UI Overhaul
Completely redesigned the frontend to match enterprise tooling UX (like Unity/VS Code style).

#### New Layout Architecture
- **Top Menu Bar**: File | Edit | View | Tools | Help + Inspector/Console toggles
- **Tab Navigation**: Dashboard | Entities | Levels | Library | AI Tools | Settings
- **Three-panel layout**: Left sub-nav + Center data grid + Right inspector
- **Bottom console panel**: Toggleable console with AI output/logs

#### New Components Created
- `Layout.jsx/css` - Main app shell with menu, tabs, panels
- `Dashboard.jsx/css` - Stats, quick actions, recent projects grid
- `Entities.jsx/css` - Full entity management with:
  - Left category rail (Actors | Items | Terrain | AI Behaviors | Scripts)
  - Sortable data grid with inline Edit/Delete
  - Right inspector panel bound to selection
- `Levels.jsx/css` - Level management with AI panel
- `Library.jsx/css` - Asset library placeholder (textures, models, audio, scripts, templates)
- `AITools.jsx/css` - AI tools (Prompt Editor, Model Settings, History, Feedback)
- `Settings.jsx/css` - Sectioned settings (Project | AI | UI | Export)
- `PlaceholderPages.css` - Shared styles for Library/AITools

#### Keyboard Navigation
- `Ctrl+1-6`: Switch between tabs
- `Ctrl+I`: Toggle inspector panel
- `Ctrl+`` `: Toggle console panel
- `Escape`: Close menus/modals

#### Inspector Integration
- Global inspector panel shows selected item details
- Binds to selected entities, levels, projects
- Shows metadata, properties, editable fields
- Entity edit form renders in inspector

#### Console/AI Output
- Bottom docked panel with tabs (Console | AI Output | Logs)
- Auto-scrolls to latest output
- Shows generation progress, errors, status
- Clear button to reset

### Technical Changes
- All new components in `/src/components/`
- CSS uses CSS variables for theming
- Clean separation of concerns
- Enterprise-style dark theme (#0f0f1a base)
- Theme system with light/dark modes

### Git Status
- Previous commit: "Add progress bar (#22), custom entity types (#15), and Ollama fallback"
- Branch: feature/save-load-db
- New changes ready to commit (UX redesign + theme system)

### Next Steps
- Test the theme switching in Settings
- Commit all changes to git
- Consider adding canvas editor functionality
